import pygame
import sys
import random

# Initialize Pygame
pygame.init()

# Set up the screen dimensions
screen_width = 800
screen_height = 600
screen = pygame.display.set_mode((screen_width, screen_height))
pygame.display.set_caption("My Pet Skunk")

# Colors
BLACK = (0, 0, 0)
WHITE = (255, 255, 255)
GREEN = (0, 255, 0)
RED = (255, 0, 0)

# Skunk class
class Skunk(pygame.sprite.Sprite):
    def __init__(self, image, position):
        super().__init__()
        self.image = pygame.transform.scale(pygame.image.load(image), (50, 50))  # Resize skunk image
        self.rect = self.image.get_rect(center=position)
        self.position = position
        self.speed = 2  # Adjust speed as needed
        self.direction = random.choice(['up', 'down', 'left', 'right'])

    def update(self, house_rect):
        if self.direction == 'up':
            self.rect.y -= self.speed
            if self.rect.top < house_rect.top:
                self.direction = 'down'
        elif self.direction == 'down':
            self.rect.y += self.speed
            if self.rect.bottom > house_rect.bottom:
                self.direction = 'up'
        elif self.direction == 'left':
            self.rect.x -= self.speed
            if self.rect.left < house_rect.left:
                self.direction = 'right'
        elif self.direction == 'right':
            self.rect.x += self.speed
            if self.rect.right > house_rect.right:
                self.direction = 'left'

    def draw(self, screen):
        screen.blit(self.image, self.rect)

    def is_clicked(self, mouse_pos):
        return self.rect.collidepoint(mouse_pos)

def aim_message(screen):
    # Font settings
    font = pygame.font.SysFont(None, 36)

    # Message to be displayed
    message = "The aim is"

    # Calculate text size and position
    text_surface = font.render(message, True, WHITE)
    text_width, text_height = text_surface.get_size()
    box_width = text_width + 20
    box_height = text_height + 20
    box_left = (screen_width - box_width) // 2
    box_top = 50  # Adjusted to display the message at the top

    # Create a surface for the message box
    message_box_surface = pygame.Surface((box_width, box_height))
    message_box_surface.fill(BLACK)

    # Render the message onto the message box surface
    message_box_surface.blit(text_surface, ((box_width - text_width) // 2, (box_height - text_height) // 2))

    # Draw the message box onto the screen
    pygame.draw.rect(screen, WHITE, (box_left, box_top, box_width, box_height), 2)
    screen.blit(message_box_surface, (box_left, box_top))

    # Update the display
    pygame.display.flip()


def loading_screen(screen):
    # Play music
    play_music()

    # Loading progress
    loading_progress = 0

    # Main loop
    while loading_progress <= 100:
        for event in pygame.event.get():
            if event.type == pygame.QUIT:
                pygame.quit()
                sys.exit()

        # Clear the screen
        screen.fill(BLACK)

        # Draw loading text
        font = pygame.font.SysFont(None, 36)
        text = font.render("Loading...", True, WHITE)
        text_rect = text.get_rect(center=(screen_width // 2, screen_height // 2 - 50))
        screen.blit(text, text_rect)

        # Draw loading progress bar
        pygame.draw.rect(screen, GREEN, (screen_width // 2 - 150, screen_height // 2, 300, 30))
        pygame.draw.rect(screen, WHITE, (screen_width // 2 - 150, screen_height // 2, loading_progress * 3, 30))

        # Update the display
        pygame.display.flip()

        # Simulate loading progress
        loading_progress += 1
        pygame.time.wait(20)  # Adjust the wait time for smoother progress bar animation

    return True


def title_screen(screen, player_name):
    # Clear the screen
    screen.fill(BLACK)

    # Draw title text
    font = pygame.font.SysFont(None, 72)
    text = font.render("My Pet Skunk", True, WHITE)
    text_rect = text.get_rect(center=(screen_width // 2, screen_height // 2 - 100))
    screen.blit(text, text_rect)

    # Draw start button
    pygame.draw.rect(screen, GREEN, (screen_width // 2 - 100, screen_height // 2 - 25, 200, 50))
    font = pygame.font.SysFont(None, 36)
    text = font.render("Start", True, BLACK)
    text_rect = text.get_rect(center=(screen_width // 2, screen_height // 2))
    screen.blit(text, text_rect)

    # Draw quit button
    pygame.draw.rect(screen, RED, (screen_width // 2 - 100, screen_height // 2 + 75, 200, 50))
    text = font.render("Quit", True, BLACK)
    text_rect = text.get_rect(center=(screen_width // 2, screen_height // 2 + 100))
    screen.blit(text, text_rect)

    # Update the display
    pygame.display.flip()

    # Wait for the player to click the start or quit button
    while True:
        for event in pygame.event.get():
            if event.type == pygame.QUIT:
                pygame.quit()
                sys.exit()
            elif event.type == pygame.MOUSEBUTTONDOWN:
                mouse_pos = pygame.mouse.get_pos()
                if screen_width // 2 - 100 <= mouse_pos[0] <= screen_width // 2 + 100:
                    if screen_height // 2 - 25 <= mouse_pos[1] <= screen_height // 2 + 25:
                        # Start button clicked
                        stop_music()  # Stop the music
                        play_phone_ring()  # Play phone ringing sound
                        dialogue_lines = [
                            f"Hi, {player_name}, I have some news.",
                            "Aunt Gertrude is dead.",
                            "What do you mean, 'who's Aunt Gertrude?'",
                            "Okay, well, she's dead. And she left you something in her will.",
                            "No, it's not money...",
                            "She left you her pet skunk, Breezy.  No, I'm not kidding.",
                            "You need to go pick up Breezy right now. Take good care of him.",
                            "Bye."
                        ]
                        display_dialogue(screen, dialogue_lines)
                        # Update aunthouse_displayed to True
                        return True
                    elif screen_height // 2 + 75 <= mouse_pos[1] <= screen_height // 2 + 125:
                        # Quit button clicked
                        pygame.quit()
                        sys.exit()

def display_image(screen, image_path):
    # Load image
    image = pygame.image.load(image_path)
    image_rect = image.get_rect()

    # Center the image on the screen
    image_rect.center = (screen_width // 2, screen_height // 2)

    # Display the image
    screen.blit(image, image_rect)

    # Update the display
    pygame.display.flip()

    # Wait for a key press or mouse click to continue
    waiting = True
    while waiting:
        for event in pygame.event.get():
            if event.type == pygame.QUIT:
                pygame.quit()
                sys.exit()
            elif event.type == pygame.KEYDOWN or event.type == pygame.MOUSEBUTTONDOWN:
                waiting = False

def display_dialogue(screen, dialogue_lines):
    # Display dialogue lines with typewriter effect
    font = pygame.font.SysFont(None, 24)
    y_position = screen_height - 150

    for line in dialogue_lines:
        displayed_text = ""
        for char in line:
            # Render displayed text
            displayed_text += char
            text = font.render(displayed_text, True, WHITE)
            text_rect = text.get_rect(left=100, top=y_position)

            # Clear the screen
            screen.fill(BLACK)

            # Draw speech bubble
            pygame.draw.rect(screen, WHITE, (50, y_position - 30, screen_width - 100, 60), 2)

            # Blit the text onto the screen
            screen.blit(text, text_rect)

            # Update the display
            pygame.display.flip()

            # Pause briefly to simulate typewriter effect
            pygame.time.wait(30)  # Adjust the wait time as needed

        # Wait for a key press to continue to the next line
        waiting = True
        while waiting:
            for event in pygame.event.get():
                if event.type == pygame.QUIT:
                    pygame.quit()
                    sys.exit()
                elif event.type == pygame.KEYDOWN or event.type == pygame.MOUSEBUTTONDOWN:
                    waiting = False

def play_phone_ring():
    # Play phone ringing sound
    pygame.mixer.Sound("phonering.mp3").play()

def play_music():
    # Play background music
    pygame.mixer.music.load("skunkmusic.mp3")
    pygame.mixer.music.play(-1)  # Loop the music indefinitely

def stop_music():
    pygame.mixer.music.stop()

def get_player_name(screen):
    # Clear the screen
    screen.fill(BLACK)

    # Draw prompt text
    font = pygame.font.SysFont(None, 36)
    text = font.render("Enter your name:", True, WHITE)
    text_rect = text.get_rect(center=(screen_width // 2, screen_height // 2 - 50))
    screen.blit(text, text_rect)

    # Update the display
    pygame.display.flip()

    # Input loop
    input_text = ""
    input_rect = pygame.Rect(screen_width // 2 - 100, screen_height // 2, 200, 50)
    active = True
    while active:
        for event in pygame.event.get():
            if event.type == pygame.QUIT:
                pygame.quit()
                sys.exit()
            elif event.type == pygame.KEYDOWN:
                if event.key == pygame.K_RETURN:
                    active = False
                elif event.key == pygame.K_BACKSPACE:
                    input_text = input_text[:-1]
                else:
                    input_text += event.unicode

        # Clear the input area
        pygame.draw.rect(screen, BLACK, input_rect)

        # Render the input text
        font = pygame.font.SysFont(None, 36)
        text_surface = font.render(input_text, True, WHITE)
        screen.blit(text_surface, (input_rect.x + 5, input_rect.y + 5))

        # Draw input area rectangle
        pygame.draw.rect(screen, WHITE, input_rect, 2)

        # Update the display
        pygame.display.flip()

    return input_text

def main():
    clock = pygame.time.Clock()
    aunthouse_displayed = False

    # Display loading screen
    aunthouse_displayed = loading_screen(screen)

    # Start the main game loop
    if aunthouse_displayed:
        player_name = get_player_name(screen)
        if title_screen(screen, player_name):  # Check if player clicked "Start"
            clock = pygame.time.Clock()
            # Create the skunk NPC
            skunk = Skunk("pet_skunk.png", (screen_width // 2, screen_height // 2))
            aim_message_displayed = False  # Flag to track if aim message is displayed

            # Load aunt's house image and scale it to match screen dimensions
            aunthouse_image = pygame.image.load("aunthouse.jpeg")
            aunthouse_image = pygame.transform.scale(aunthouse_image, (screen_width, screen_height))

            while True:
                for event in pygame.event.get():
                    if event.type == pygame.QUIT:
                        pygame.quit()
                        sys.exit()
                    elif event.type == pygame.MOUSEBUTTONDOWN:
                        mouse_pos = pygame.mouse.get_pos()
                        if skunk.is_clicked(mouse_pos):
                            # Skunk is clicked, display menu
                            display_menu(screen, mouse_pos)

                # Check if aunthouse_displayed is True
                if aunthouse_displayed:
                    # Draw aunt's house background
                    screen.blit(aunthouse_image, (0, 0))
                    # Update skunk movement
                    skunk.update(pygame.Rect(0, 0, screen_width, screen_height))

                    # Check if the skunk has entered the aunt's house
                    if skunk.rect.colliderect(pygame.Rect(0, 0, screen_width, screen_height)) and not aim_message_displayed:
                        aim_message(screen)
                        aim_message_displayed = True  # Set the flag to True once the aim message is displayed

                # Draw everything
                skunk.draw(screen)

                # Display aim message on top of everything
                if aim_message_displayed:
                    aim_message(screen)

                pygame.display.flip()
                clock.tick(60)  # Limit frame rate


def display_menu(screen, position):
    # Display menu options
    font = pygame.font.SysFont(None, 24)
    menu_options = ["FEED", "PLAY", "CHECK STATS"]
    menu_height = len(menu_options) * 30
    menu_rect = pygame.Rect(position[0], position[1], 150, menu_height)

    pygame.draw.rect(screen, WHITE, menu_rect)  # Draw menu background

    # Draw menu options
    for i, option in enumerate(menu_options):
        text = font.render(option, True, BLACK)
        text_rect = text.get_rect(center=(position[0] + 75, position[1] + i * 30 + 15))
        screen.blit(text, text_rect)

    pygame.display.flip()

# Start the main game loop
if __name__ == "__main__":
    main()
